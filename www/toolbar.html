<!--
  Copyright (c) 2006-2013, JGraph Ltd
  
  Toolbar example for mxGraph. This example demonstrates using
  existing cells as templates for creating new cells.
-->
<html>
<head>
	<title>Toolbar example for mxGraph</title>
	<meta charset="UTF-8">

	<!-- Sets the basepath for the library if not in same directory -->
	<script type="text/javascript">
		mxBasePath = '../src';
	</script>

	<!-- Loads and initializes the library -->
	<script type="text/javascript" src="../src/js/mxClient.js"></script>

	<!-- Example code -->
	<script type="text/javascript">
		// Program starts here. Creates a sample graph in the
		// DOM node with the specified ID. This function is invoked
		// from the onLoad event handler of the document (see below).
		function main()
		{
			// Checks if browser is supported
			if (!mxClient.isBrowserSupported())
			{
				// Displays an error message if the browser is
				// not supported.
				mxUtils.error('Browser is not supported!', 200, false);
			}
			else
			{
				// Creates the div for the toolbar 最左边的 toolbar
				var tbContainer = document.createElement('div');
				tbContainer.style.position = 'absolute';
				tbContainer.style.overflow = 'hidden';
				tbContainer.style.padding = '2px';
				tbContainer.style.left = '0px';
				tbContainer.style.top = '26px';
				tbContainer.style.width = '84px';
				tbContainer.style.bottom = '0px';
				document.body.appendChild(tbContainer);
				// Creates new toolbar with event processing
				var toolbar = new mxToolbar(tbContainer);
				toolbar.enabled = true
				
				// Creates the div for the graph 右边的画布部分
				container = document.createElement('div');
				container.style.position = 'absolute';
				container.style.overflow = 'hidden';
				container.style.left = '84px';
				container.style.top = '26px';
				container.style.right = '0px';
				container.style.bottom = '0px';
				container.style.background = 'url("editors/images/grid.gif")';

				document.body.appendChild(container);
				
				// Workaround for Internet Explorer ignoring certain styles
				if (mxClient.IS_QUIRKS)
				{
					document.body.style.overflow = 'hidden';
					new mxDivResizer(tbContainer);
					new mxDivResizer(container);
				}
	
				// Creates the model and the graph inside the container
				// using the fastest rendering available on the browser
				var model = new mxGraphModel();
				var graph = new mxGraph(container, model);
				graph.dropEnabled = true;

				///////////////////////////--- 节点上的删除操作 start ---///////////////////////////
				// Specifies the URL and size of the new control
				// 节点上删除操作的图标
				var deleteImage = new mxImage('editors/images/overlays/forbidden.png', 16, 16);
				// Overridden to add an additional control to the state at creation time
				mxCellRendererCreateControl = mxCellRenderer.prototype.createControl;
				mxCellRenderer.prototype.createControl = function(state)
				{
					mxCellRendererCreateControl.apply(this, arguments);

					var graph = state.view.graph;

					if (graph.getModel().isVertex(state.cell))
					{
						if (state.deleteControl == null)
						{
							var b = new mxRectangle(0, 0, deleteImage.width, deleteImage.height);
							state.deleteControl = new mxImageShape(b, deleteImage.src);
							state.deleteControl.dialect = graph.dialect;
							state.deleteControl.preserveImageAspect = false;

							this.initControl(state, state.deleteControl, false, function (evt)
							{
								if (graph.isEnabled())
								{
									graph.removeCells([state.cell]);
									mxEvent.consume(evt);
								}
							});
						}
					}
					else if (state.deleteControl != null)
					{
						state.deleteControl.destroy();
						state.deleteControl = null;
					}
				};

				// Helper function to compute the bounds of the control
				var getDeleteControlBounds = function(state)
				{
					if (state.deleteControl != null)
					{
						var oldScale = state.deleteControl.scale;
						var w = state.deleteControl.bounds.width / oldScale;
						var h = state.deleteControl.bounds.height / oldScale;
						var s = state.view.scale;

						return (state.view.graph.getModel().isEdge(state.cell)) ?
								new mxRectangle(state.x + state.width / 2 - w / 2 * s,
										state.y + state.height / 2 - h / 2 * s, w * s, h * s)
								: new mxRectangle(state.x + state.width - w * s,
										state.y, w * s, h * s);
					}

					return null;
				};

				// Overridden to update the scale and bounds of the control
				mxCellRendererRedrawControl = mxCellRenderer.prototype.redrawControl;
				mxCellRenderer.prototype.redrawControl = function(state)
				{
					mxCellRendererRedrawControl.apply(this, arguments);

					if (state.deleteControl != null)
					{
						var bounds = getDeleteControlBounds(state);
						var s = state.view.scale;

						if (state.deleteControl.scale != s || !state.deleteControl.bounds.equals(bounds))
						{
							state.deleteControl.bounds = bounds;
							state.deleteControl.scale = s;
							state.deleteControl.redraw();
						}
					}
				};
				// Overridden to remove the control if the state is destroyed
				mxCellRendererDestroy = mxCellRenderer.prototype.destroy;
				mxCellRenderer.prototype.destroy = function(state)
				{
					mxCellRendererDestroy.apply(this, arguments);

					if (state.deleteControl != null)
					{
						state.deleteControl.destroy();
						state.deleteControl = null;
					}
				};
				//--------------------------------  节点上的删除操作 end --------------------------------
				
				// Matches DnD inside the graph
				mxDragSource.prototype.getDropTarget = function(graph, x, y)
				{
					var cell = graph.getCellAt(x, y);
					
					if (!graph.isValidDropTarget(cell))
					{
						cell = null;
					}
					
					return cell;
				};

				// Enables new connections in the graph
				graph.setConnectable(true);
				graph.setMultigraph(false);

				// Stops editing on enter or escape keypress 按Enter或Escape键时停止编辑
				var keyHandler = new mxKeyHandler(graph);
				var rubberband = new mxRubberband(graph);
				
				var addVertex = function(icon, w, h, style)
				{
					var vertex = new mxCell(null, new mxGeometry(0, 0, w, h), style);
					vertex.setVertex(true);
				
					addToolbarItem(graph, toolbar, vertex, icon);
				};

				addVertex('editors/images/shape-kaishi.png', 100, 40, 'shape=rounded;rounded=1');
				addVertex('editors/images/shape-fangyin.png', 100, 40, 'shape=rounded;rounded=1');
				addVertex('editors/images/shape-caidan.png', 100, 40, 'shape=rounded;rounded=1');
				addVertex('editors/images/shape-zhuanjie.png', 100, 40, 'shape=rounded;rounded=1');
				addVertex('editors/images/shape-shouhao.png', 100, 40, 'shape=rounded;rounded=1');
				addVertex('editors/images/shape-shibie.png', 100, 40, 'shape=rounded;rounded=1');
				addVertex('editors/images/shape-panduan.png', 100, 40, 'shape=rounded;rounded=1');
				addVertex('editors/images/shape-ziliucheng.png', 100, 40, 'shape=rounded;rounded=1');
				addVertex('editors/images/shape-guaduan.png', 100, 40, 'shape=rounded;rounded=1');

				var button = mxUtils.button('开始', function(evt)
				{
					if (!graph.isSelectionEmpty())
					{
						// Creates a copy of the selection array to preserve its state
						var cells = graph.getSelectionCells();
						var bounds = graph.getView().getBounds(cells);

						// Function that is executed when the image is dropped on
						// the graph. The cell argument points to the cell under
						// the mousepointer if there is one.
						var funct = function(graph, evt, cell)
						{
							graph.stopEditing(false);

							var pt = graph.getPointForEvent(evt);
							var dx = pt.x - bounds.x;
							var dy = pt.y - bounds.y;

							graph.setSelectionCells(graph.importCells(cells, dx, dy, cell));
						}

						// Creates the image which is used as the drag icon (preview)
						var img = toolbar.addMode(null, 'editors/images/outline.gif', funct);
						mxUtils.makeDraggable(img, graph, funct);
					}
				});

				button.style.position = 'absolute';
				button.style.background = 'url("editors/images/fangyin.png") no-repeat';
				button.style.left = '2px';
				button.style.top = '2px';
				button.style.width = '60px';
				button.style['text-align'] = 'right';

				document.body.appendChild(button);

			}
		}

		function addToolbarItem(graph, toolbar, prototype, image)
		{
			// Function that is executed when the image is dropped on
			// the graph. The cell argument points to the cell under
			// the mousepointer if there is one.
			var funct = function(graph, evt, cell)
			{
				graph.stopEditing(false);

				var pt = graph.getPointForEvent(evt);
				var vertex = graph.getModel().cloneCell(prototype);
				vertex.geometry.x = pt.x;
				vertex.geometry.y = pt.y;
				
				graph.setSelectionCells(graph.importCells([vertex], 0, 0, cell));
			}

			// Creates the image which is used as the drag icon (preview)
			var img = toolbar.addMode(null, image, funct);
			mxUtils.makeDraggable(img, graph, funct);
		}

	</script>
</head>

<!-- Calls the main function after the page has loaded. Container is dynamically created. -->
<body onload="main();" style="margin:0px;height:100%;">
<!--<table width="100%" height="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td id="toolbar" height="80px" style="background:#7F7F7F;padding:10px;">
		</td>
	</tr>
	<tr>
		<td width="100%">
			<div id="graph" style="overflow:auto;width:100%;height:100%;">
			</div>
		</td>
	</tr>
</table>-->
</body>
</html>
